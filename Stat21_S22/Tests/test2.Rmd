---
title: "Test 2"
subtitle: "STAT 021"
author: "Swarthmore College"
output:  
  pdf_document:
    latex_engine: xelatex
fontsize: 12pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, warning=F)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(knitr)
library(tidyverse)
library(png)
library('broom')
library('cowplot')

#setwd("~/Google Drive Swat/Swat docs/Stat 21/Data")
options(htmltools.dir.version = FALSE)
#options(knitr.kable.NA = '')

#vg_data <- read_csv("~/Google Drive/Swat docs/Stat11_S20/Midterm1/vgsalesGlobale.csv")
#vg_subset <- vg_data %>% filter((Publisher=="Nintendo")|
#                                (Publisher=="Namco Bandai Games")|(Publisher=="Electronic Arts")) %>% 
#                         filter(Global_Sales <= 4)
theme_set(theme_bw())
```

```{css, echo=FALSE}
pre {
  background: #FFBB33;
  max-width: 100%;
  overflow-x: scroll;
}
```

\hspace{1in} **Do not flip this page until instructed to do so.** 

\vspace{.2in}

**Test organization:** There are $X$ questions in total on this test and they are organized into two subsections: the first **X** questions are select all that apply multiple choice questions and the last **X** questions are free response. If you need additional paper you may come to the front of the class and pick some up. There are a total of $XX$ points possible on this test. 

**Instructions:** The first part of this test are multiple choice questions that do not require any additional explanation or work. No extra work will be considered in the grading of these questions but *you can get partial credit* for many of these questions.  The last part of this test involves short answer questions. For these questions, you must show all your work and/or provide enough justification and explain your reasoning in order to get full credit or be considered for partial credit. You do not need a calculator to evaluate any expressions. For any calculation problems, simply writing out the formula to find the answer will suffice. 


\vspace{.2in}

**First and Last Name:** _____________________________

\vspace{.2in}

**Swarthmore Username:** ______________________________

\vspace{0.5cm}


**Take a deep breath.** 

You have prepared for this test and with a clear and well-rested mind, you are ready to show me what you have learned this semester. As with the other tests, the purpose of this test is to measure your understanding of the material we have covered. This is nothing more than a metric for me to evaluate your preparedness to think statistically at this particular moment in time and in this particular setting. This is not a perfect measure of your knowledge and does not predict your future statistical skills. 



```{r echo=FALSE}
mobility <- read_csv("mobility.csv")

## To do: think of another way to categorize states, red/blue/purple ? (year is 1980-1982)
Confederacy = c("AR","AL","FL","GA","LA","MS","NC","SC","TN","TX","VA")
mobility$Dixie = mobility$State %in% Confederacy %>% factor
mobility$...1 = mobility$ID
mobility0 <- mobility %>% select(-c("Latitude", "Longitude"))

```

\pagebreak

## Multiple choice problems (2 points each)


```{r echo=FALSE}
#mobility %>% head
set.seed(101)
rsamp <- sample(1:length(mobility0$State), 70, replace=FALSE)
mobility <- mobility0[rsamp,] 
n<-length(mobility$State)
k <- 3
mod_mobility <- lm(Mobility ~ Commute + Dixie + Commute*Dixie, data=mobility)

influential_pts_data <- mobility %>% mutate(studresids = rstudent(mod_mobility),
                                            leverage = hatvalues(mod_mobility),
                                            cooksd = cooks.distance(mod_mobility),
                                            e_as_h1 = abs(sqrt(((1/leverage)-1)*(0.5*(k+1)))),
                                            e_as_h2 = abs(sqrt(((1/leverage)-1)*(1*(k+1)))))
                                            # fits = mod_mobility$fitted.values,
## plot lines where cooksd = 0.5 and 1 
## d = (stures^2/(k+1))*(h/(1-h))
## plot lines where studresids = 2 and 3 
## plot lines where leverage = 4/n and 6/n 


ggplot(data=influential_pts_data) + 
  geom_point(aes(x=leverage, y=studresids),size=1.5) + ylim(-12,12) +
  geom_hline(yintercept=2, col="green", lty=3, size=1)+geom_hline(yintercept=-2, col="green", lty=3, size=1) +
  geom_hline(yintercept=3, col="green", lty=2, size=1)+geom_hline(yintercept=-3, col="green", lty=2, size=1) +
  geom_vline(xintercept=4/n, col="blue", lty=3, size=1)+geom_vline(xintercept=6/n, col="blue", lty=2, size=1) +
  geom_smooth(aes(x=leverage, y=e_as_h1), lty=3, col="purple", se=FALSE)+
    geom_smooth(aes(x=leverage, y=-e_as_h1), lty=3, col="purple", se=FALSE) + 
  geom_smooth(aes(x=leverage, y=e_as_h2), lty=2, col="purple", se=FALSE)+
    geom_smooth(aes(x=leverage, y=-e_as_h2), lty=2, col="purple", se=FALSE)
  
```

MC questions: identify reference level, interpretation of intercept, etc; identify influential points according to different metrics; nested f-test for significance of categorical predictor 

Which of these is unlike the others: 
VIT, Cook's D, influence, leverage, studentized residuals, R^2 



### 1 


\pagebreak 

# Short answer questions 

**Problem 1**


The R-output below contains the results from a regression model fit to a data set concerning life expectancy in years, alcohol consumption in drinks per day, and smoking status (smoker - Yes vs. non-smoker - No). Answer the following questions pertaining to the R output below. 


```{r echo=TRUE, eval=FALSE}
## Call:
## lm(formula = Lifespan ~ Alcohol + Smoker)
 
## Residuals:
## Min 1Q Median 3Q Max
## -30.796 -7.139 0.125 6.949 19.578
 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)
## (Intercept) 93.6818  2.1024     44.56   <2e-16 ***
## Alcohol     -3.2656  0.3147    -10.38   <2e-16 ***
## SmokerYes  -23.4392  1.9922    -11.77   <2e-16 ***
## ---
## Signif. codes: 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
## Residual standard error: 9.959 on 97 degrees of freedom
## Multiple R-squared: 0.7129, Adjusted R-squared: 0.7069
## F-statistic: 120.4 on 2 and 97 DF, p-value: < 2.2e-16
``` 
 

a) How does drinking alcohol affect average life expectancy? 

b) Suppose someone consumes about 2.5 alcoholic drinks per day and smokes regularly. Calculate (provide the formula for) the average life expectancy for this individual. 

c) What is the average difference in lifespan between smokers and non-smokers? 

d) Supposing we fix the amount of alcohol consumption; is there a statistically significant relationship between life expectancy and smoking status? Justify your answer. 

e) How much of the variation in lifespan can be explained by smoking status and alcohol consumption? 

f) Which of the questions above are questions of statistical inference? 


\newpage

**Problem 2** 

```{r echo=FALSE}
# For next year, find or create a new data set for MLR with an interaction term 
data("ToothGrowth")
```


Let's examine the impact of Vitamin C from two sources and at two different dosages on the growth of teeth in Guinea pigs. The variables in the data set are:

- *len* - the length of growth in the teeth

- *supp.VC* - a binary categorical variable that is 1 if the Vitamin C supplement type is ascorbic acid and is 0 if the Vitamin C supplement type is orange juice. 

- *dose.2.0* - is a binary categorical variable that is 1 if the amount of Vitamin C is 2.0 mg and is 0 if the amount of Vitamin C is 1.0 mg.


```{r echo=TRUE, eval=FALSE}
teeth_SLR_main<-lm(len ~ supp + dose)
summary(teeth_SLR_main)

## Call:
## lm(formula = len ~ supp + dose)

## Residuals:
##    Min     1Q Median     3Q    Max 
## -6.697 -2.765 -1.005  2.178  9.262 

## Coefficients:
##                     Estimate Std. Error t value   Pr(>|t|)    
## (Intercept)          21.197      1.061  19.976    < 2e-16 ***
## supp.aa              -2.925      1.225  -2.387     0.0222 *  
## dose.2.0              6.365      1.225   5.195   7.72e-06 ***
## ---
## Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

## Residual standard error: 3.875 on 37 degrees of freedom
## Multiple R-squared:  0.469,	Adjusted R-squared:  0.4403 
## F-statistic: 16.34 on 2 and 37 DF,  p-value: 8.202e-06
```



a) Write the down the main effects equations (in numbers) for predicting the average tooth growth for Guinea pics who: 

    1) Have supplement type absorbic acid and dosage of 1.0 mg 
    2) Have supplement type absorbic acid and dosage of 2.0 mg 
    3) Have supplement type orange juice and dosage of 1.0 mg 
    4) Have supplement type orange juice and dosage of 2.0 mg 


\pagebreak 

```{r echo=TRUE, eval=FALSE}
teeth_SLR_int<-lm(len ~ supp + dose + supp*dose)
summary(teeth_SLR_int)

## Call:
## lm(formula = len ~ supp * dose)

## Residuals:
##    Min     1Q Median     3Q    Max 
## -8.200 -2.337 -0.005  2.147  7.760 

## Coefficients:
##                         Estimate Std. Error   t value   Pr(>|t|)    
## (Intercept)               22.700      1.137    19.969    < 2e-16 ***
## supp.aa                   -5.930      1.608    -3.689    0.00074 ***
## dose.2.0                   3.360      1.608     2.090    0.04374 *  
## supp.aa:dose.2.0           6.010      2.274     2.643    0.01208 *  
## ---
## Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

## Residual standard error: 3.595 on 36 degrees of freedom
## Multiple R-squared:  0.5553,	Adjusted R-squared:  0.5183 
## F-statistic: 14.99 on 3 and 36 DF,  p-value: 1.717e-06
```

b) Write the down the interaction effects equations (in numbers) for predicting the average tooth growth for Guinea pics who: 

    1) Have supplement type absorbic acid and dosage of 1.0 mg 
    2) Have supplement type absorbic acid and dosage of 2.0 mg 
    3) Have supplement type orange juice and dosage of 1.0 mg 
    4) Have supplement type orange juice and dosage of 2.0 mg 


c) Based on the R output above and the residual plots on the next page, which model do you think is a better choice, the one **with** interactions or the one **without** interactions? Justify your answer. 

d) For whichever model you chose in part (c), explain the relationship between supplement type and tooth growth in language that can be understood by an average high school student. 



\newpage


**Problem 2 Plots** 

```{r echo=FALSE}
library("MASS")
teeth_SLR_main<-lm(len ~ supp + dose, ToothGrowth)
teeth_SLR_int<-lm(len ~ supp + dose + supp*dose, ToothGrowth)
resid_data_teeth <- ToothGrowth %>% mutate(resid_main = studres(teeth_SLR_main),
                                 resid_int = studres(teeth_SLR_int),
                                 yhat_main = teeth_SLR_main$fitted.values,
                                 yhat_int = teeth_SLR_int$fitted.values)
ggplot(resid_data_teeth, aes(x=yhat_main, y=resid_main)) +
  geom_point() + 
  geom_hline(yintercept=0) +
  labs(title="Residual plot for main effects model", 
       x="Predicted tooth length", y="Studentized residuals")
```

```{r echo=FALSE}
ggplot(resid_data_teeth, aes(x=yhat_int, y=resid_int)) +
  geom_point() + 
  geom_hline(yintercept=0) +
  labs(title="Residual plot for interaction effects model", 
       x="Predicted tooth length", y="Studentized residuals")
```

\newpage 

**Problem 3** 

Suppose we are trying to understand how the aerial biomass (response variable) production of a certain type of marsh grass is related to the three predictor variables *pH*, which measures the pH level of the soil (from 0-14), *K*, which measures the potassium level of the soil (in ppm), and the categorical variable *location* which can be one of three different spots ("OI" is short for Oak Island - this is the reference level, "SI" is short for Smith Island, and "SM" is short for Snows Marsh). Aerial biomass is measured with units $gm^{-2}$. 

```{r}
biomass <- read_table2(url(
  "http://www.swarthmore.edu/NatSci/sthornt1/DataFiles/biomass_data.txt"), col_names = TRUE)
```

Consider the fit of a MLR regression model that includes the main effects of location, *pH*, and *K* with the response. The residual plot and Normal probability plot for this model are show on the next page.  


```{r}
MLR_bio <- lm(BIO ~ as_factor(Location) + pH + K , data = biomass)
summary(MLR_bio)
```


a) What is the average (absolute) difference in biomass (in $gm^{-2}$) for moss found in Smith Island versus moss found in the Snows Marsh? 

b) What is the average (absolute) difference in biomass (in $gm^{-2}$) if the potassium (variable *K*) in the soil increases by 500 ppm? 


c) Based on this output, is it correct to say that the effect of changing pH level of the soil has a greater impact on the biomass than changing the potassium levels? Why or why not? 

 
\newpage 

**Problem 3 Plots** 

```{r echo=FALSE}
resid_data_biomass1 <- biomass %>% mutate(resid1 = studres(MLR_bio),
                                          resid2 = studres(MLR_bio_std),
                                          yhat1 = MLR_bio$fitted.values,
                                          yhat2 = MLR_bio_std$fitted.values)
p3.1 <- ggplot(resid_data_biomass1, aes(x=yhat1, y=resid1)) +
  geom_point() + 
  geom_hline(yintercept=0) +
  labs(title="Residual plot for biomass data", 
       x="Predicted biomass", y="Studentized residuals")
```

```{r echo=FALSE}
QQlarge <- ggplot(resid_data_biomass1, aes(sample = resid1))
p3.2 <- QQlarge + stat_qq() + stat_qq_line() + 
  labs(title = "NPP for the original \n main effects model", x="Normal quantiles", y="Residual quantiles")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
grid.arrange(p3.1, p3.2, nrow=1)
```


```{r echo=FALSE}
p3.3 <- ggplot(resid_data_biomass1, aes(x=yhat2, y=resid2)) +
  geom_point() + 
  geom_hline(yintercept=0) +
  labs(title="Residual plot for biomass data \n after standardizing \n the  predictors", 
       x="Predicted biomass", y="Studentized residuals")
```

```{r echo=FALSE}
QQlarge <- ggplot(resid_data_biomass1, aes(sample = resid2))
p3.4 <- QQlarge + stat_qq() + stat_qq_line() + 
  labs(title = "NPP for main effects model with \n standardized predictors", x="Normal quantiles", y="Residual quantiles")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
grid.arrange(p3.3, p3.4, nrow=1)
```


\newpage 

**Problem 4** 
```{r echo=FALSE}
# For next year, find or create a new data set for MLR with a transformation of the response
```


Suppose instead of looking at the relationship between biomass and the predictor variables, we decide to look at the relationship between **the logarithm of the biomass** and the predictor variables. The residual plot and Normal probability plots based on this model are show on the next page. As a reminder, the logarithmic function is defined by the relationship that if $y = log_{a}(x)$ then $a^{y}=x$ (and vice versa). 

```{r echo=FALSE}
biomass2 <- biomass %>% mutate(log_biomass = log(BIO))

MLR_bio_transformed <- lm(log_biomass ~ as_factor(Location) + pH + K , data = biomass2)
summary(MLR_bio_transformed)
```

a) Does this model look better or worse compared to the model in Problem 3? Justify your answer. 



b) What is the average difference in the response variable based on this linear regression model when  the potassium in the soil increases by 500 ppm? 


c) Are the answers to part (a) of Problem 4 and part (b) of Problem 3 directly comparable? Why or why not? 


 
\newpage 

**Problem 4 Plots** 

```{r echo=FALSE}
resid_data_biomass2 <- biomass2 %>% mutate(resid = studres(MLR_bio_transformed),
                                           yhat = MLR_bio_transformed$fitted.values)
ggplot(resid_data_biomass2, aes(x=yhat, y=resid)) +
  geom_point() + 
  geom_hline(yintercept=0) +
  labs(title="Residual plot for biomass data", subtitle="Logarithmic transformation of the response variable",
       x="Predicted logarithm of biomass", y="Studentized residuals")
```

```{r echo=FALSE}
QQlarge <- ggplot(resid_data_biomass2, aes(sample = yhat))
QQlarge + stat_qq() + stat_qq_line() + 
  labs(title = "NPP for biomass data", subtitle="Logarithmic transformation of the response variable", x="Normal quantiles", y="Residual quantiles")
```



\pagebreak 

**Problem 5** 

```{r}
coasters <- read_table2(url(
  "http://www.swarthmore.edu/NatSci/sthornt1/DataFiles/roller_coasters.txt")) %>%  
  filter(!is.na(Duration) & !is.na(Inversions)) 
## add a step to make sure categorical varbs are factors 
head(coasters) 
```


Suppose we have randomly surveyed 91 roller coasters across the US. We are interested in investigating the relationship among a set of predictor variables with the quantitative response variable, the maximum speed of the coaster (mph). The quantitative predictor variables we are going to consider include 

  - the length of the track (in feet), 

  - the duration of the ride (in seconds), 

  - the highest climb the ride reaches (in feet), and 

  - the lowest drop the ride reaches (in feet) - coasters can extend below ground. 

The categorical predictor variables we are going to consider are 

  - the type of track (wooden or steel) and 

  - whether or not the ride has a loop/inversion (1 for yes, 0 for no). 

**Note:** For this data set, we are given that the data is a random sample so we can assume that it is representative of all roller coasters in the US. You can also assume that the data is independent for this example. 


(a) Create a scatter plot matrix for all of the quantitative variables and create box plots for each of the categorical variables (with coaster speed on the vertical axis). Does there appear to be any evidence of multicollinearity among the quantitative predictors?  


(b) Fit the following four regression models to this data and write out the corresponding estimated regression equations as well as the adjusted coefficient of determination for each model. 

Model 1: $E[Y | \text{length, climb}] = \beta_0 + \beta_1 \text{length} + \beta_2 \text{climb}  + \epsilon$

Model 2: $E[Y | \text{length, climb, type}] = \beta_0 + \beta_1 \text{length} + \beta_2 \text{climb}  + \beta_3 w_{type}  + \epsilon$, where $w_{type} = \begin{cases} 1, \text{ if steel} \\ 0, \text{ otherwise}\end{cases}$

Model 3: $E[Y | \text{duration, drop}] = \beta_0 + \beta_1 \text{duration}+ \beta_2 \text{drop} + \epsilon$

Model 4:  $E[Y | \text{duration, drop, loop}] = \beta_0 + \beta_1 \text{duration} + \beta_2 \text{drop} + \beta_3 w_{loop} + \epsilon$, where $w_{loop} = \begin{cases} 1, \text{ if has inversion} \\ 0, \text{ otherwise}\end{cases}$

\pagebreak 

(c) Perform a thorough analysis of the studentized residuals for each of the four models you fit in part (b). Make sure every plot is clearly labeled and include at least a one sentence statement explaining the relevance of each plot.

(d) Suppose your friend's favorite ride is the Wicked Twister and they want to know what is the estimated maximum speed this coaster reaches. This a steel roller coaster that reaches a height of 215 ft, has a drop of 206 ft, is 675 ft long, lasts for 40 seconds, and has no inversions. Based on your answers to parts (a)- (c),  which of the regression models are appropriate to use to answer your friend's question about the Wicked Twister?

(e) Wikipedia lists the speed of the Wicked Twister as 72 mph. Suppose we want to determine if there is a statistically significant difference between the speed reported by Wikipedia and the estimated maximum speed based on one of our models. Explain how we could do this and state which models from part (b) (if any) are appropriate to use to answer this question. Explain your answer. 