---
title: "Test 2"
subtitle: "STAT 021"
author: "Swarthmore College"
output:  
  pdf_document:
    latex_engine: xelatex
fontsize: 12pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, warning=F)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(knitr)
library(tidyverse)
library(png)
library('broom')
library('cowplot')

#setwd("~/Google Drive Swat/Swat docs/Stat 21/Data")
options(htmltools.dir.version = FALSE)
#options(knitr.kable.NA = '')

#vg_data <- read_csv("~/Google Drive/Swat docs/Stat11_S20/Midterm1/vgsalesGlobale.csv")
#vg_subset <- vg_data %>% filter((Publisher=="Nintendo")|
#                                (Publisher=="Namco Bandai Games")|(Publisher=="Electronic Arts")) %>% 
#                         filter(Global_Sales <= 4)
theme_set(theme_bw())
```

```{css, echo=FALSE}
pre {
  background: #FFBB33;
  max-width: 100%;
  overflow-x: scroll;
}
```

\hspace{1in} **Do not flip this page until instructed to do so.** 

\vspace{.2in}

**Test organization:** There are $8$ questions in total on this test and they are organized into two subsections: the first **4** questions are select all that apply multiple choice questions and the last **4** questions are free response. If you need additional paper you may come to the front of the class and pick some up. There are a total of $30$ points possible on this test. 

**Instructions:** The first part of this test are multiple choice questions that do not require any additional explanation or work. No extra work will be considered in the grading of these questions but *you can get partial credit* for many of these questions.  The last part of this test involves short answer questions. For these questions, you must show all your work and/or provide enough justification and explain your reasoning in order to get full credit or be considered for partial credit. You do not need a calculator to evaluate any expressions. For any calculation problems, simply writing out the formula to find the answer will suffice. 


\vspace{.2in}

**First and Last Name:** _____________________________

\vspace{.2in}

**Swarthmore Username:** ______________________________

\vspace{0.5cm}


**Take a deep breath.** 

You have prepared for this test and with a clear and well-rested mind, you are ready to show me what you have learned this semester. As with the other tests, the purpose of this test is to measure your understanding of the material we have covered. This is nothing more than a metric for me to evaluate your preparedness to think statistically at this particular moment in time and in this particular setting. This is not a perfect measure of your knowledge and does not predict your future statistical skills. 



```{r echo=FALSE}
mobility <- read_csv("mobility.csv")

## To do: think of another way to categorize states, red/blue/purple ? (year is 1980-1982)
Confederacy = c("AR","AL","FL","GA","LA","MS","NC","SC","TN","TX","VA")
mobility$Dixie = mobility$State %in% Confederacy %>% factor
mobility$...1 = mobility$ID
mobility0 <- mobility %>% select(-c("Latitude", "Longitude"))
#mobility %>% head
```

\pagebreak

## Multiple choice problems (2 points each)

Use the following information to answer questions 1-4.

Suppose we are trying to understand how the aerial biomass (response variable) production of a certain type of marsh grass is related to the three predictor variables 

- *pH*, which measures the pH level of the soil (from 0-14), 

- *K*, which measures the potassium level of the soil (in ppm), and 

- the categorical variable *location* which can be one of three different spots ("OI" is short for Oak Island, "SI" is short for Smith Island, and "SM" is short for Snows Marsh). 

Aerial biomass is called `BIO` and is measured with units $gm^{-2}$. 


```{r echo=FALSE}
biomass <- read_table2("biomass_data.txt", col_names = TRUE) 
biomass$Location <- biomass$Location %>% as.factor
```

Consider the main effects model shown below. The summary output is shown on the next page. Below the model summary is a plot of the studentized residuals and leverage values for each data point based on this model. The heavy dashed lines represent "extreme" cutoffs and the short dashed lines represent "moderate" cutoffs for leverage (blue), studentized residuals (green), and Cook's distance (purple), respectively. 


$$\hat{biomass} = \hat{\beta}_0 + \hat{\beta}_1 pH + \hat{\beta}_2 K + \hat{\beta}_3 LocationSI + \hat{\beta}_4 LocationSM, \text{ where}$$
$LocationSI = \begin{cases} 1, \text{ if at Smith Island} \\ 0, \text{ otherwise} \end{cases} \text{ and } LocationSM = \begin{cases} 1, \text{ if at Snows Marsh} \\ 0, \text{ otherwise} \end{cases}$


```{r echo=FALSE}
MLR_bio <- lm(BIO ~ pH + K + Location, data = biomass)
summary(MLR_bio)
```

```{r echo=FALSE}
#mobility %>% head
set.seed(101)
rsamp <- sample(1:length(mobility0$State), 70, replace=FALSE)
mobility <- mobility0[rsamp,] 
mobility[65,2] <- .4  ## to create extreme Cook's D (fake data)
n<-length(mobility$State)
k <- 3
mod_mobility <- lm(Mobility ~ Commute + Dixie + Commute*Dixie, data=mobility)

influential_pts_data <- mobility %>% mutate(studresids = rstudent(mod_mobility),
                                            leverage = hatvalues(mod_mobility),
                                            cooksd = cooks.distance(mod_mobility),
                                            e_as_h1 = abs(sqrt(((1/leverage)-1)*(0.5*(k+1)))),
                                            e_as_h2 = abs(sqrt(((1/leverage)-1)*(1*(k+1)))))
                                            # fits = mod_mobility$fitted.values,
## plot lines where cooksd = 0.5 and 1 
## d = (stures^2/(k+1))*(h/(1-h))
## plot lines where studresids = 2 and 3 
## plot lines where leverage = 2k/n and 3k/n 


ggplot(data=influential_pts_data) + 
  geom_point(aes(x=leverage, y=studresids),size=1.5) + ylim(-12,12) +
     geom_text(aes(x=leverage, y=studresids), label=rownames(influential_pts_data), nudge_y = -.7) +
  geom_hline(yintercept=2, col="green", lty=3, size=1)+geom_hline(yintercept=-2, col="green", lty=3, size=1) +
  geom_hline(yintercept=3, col="green", lty=2, size=1)+geom_hline(yintercept=-3, col="green", lty=2, size=1) +
  geom_vline(xintercept=2*k/n, col="blue", lty=3, size=1)+geom_vline(xintercept=3*k/n, col="blue", lty=2, size=1) +
  geom_smooth(aes(x=leverage, y=e_as_h1), lty=3, col="purple", se=FALSE)+
    geom_smooth(aes(x=leverage, y=-e_as_h1), lty=3, col="purple", se=FALSE) + 
  geom_smooth(aes(x=leverage, y=e_as_h2), lty=2, col="purple", se=FALSE)+
    geom_smooth(aes(x=leverage, y=-e_as_h2), lty=2, col="purple", se=FALSE) 
```



## Problem 1

Which of the following statements *are not* supported by the R output for this model? (Circle all that apply.)

(a) The effect of changing pH level of the soil has a greater impact on the biomass than changing the potassium level, given the location of the grass is the same. 

(b) The effect of changing the pH level of the soil on the biomass depends on the potassium level of the soil. 


(c) The effect of changing the potassium level of the soil has a greater impact on the biomass than changing the pH level, given the location of the grass is the same. 

(d) Comparing grass from soil with matching pH levels and matching potassium levels, grass from the Snows Marsh tends to have higher biomass than grass from Oak Island. 



## Problem 2

In comparison to the model above, which of the following are *not valid* reduced models? (Circle all that apply.)

(a) $\hat{biomass} = \hat{\beta}_0 + \hat{\beta}_1 pH + \hat{\beta}_2 K +  \hat{\beta}_4 LocationSM$

(b) $\hat{biomass} = \hat{\beta}_0$

(c) $\hat{biomass} = \hat{\beta}_0 + \hat{\beta}_1 pH + \hat{\beta}_2 K$

(d) $\hat{biomass} = \hat{\beta}_0 + \hat{\beta}_1 pH + \hat{\beta}_2 K + \hat{\beta}_3 LocationSI$


## Problem 3 

Which of the following data points are likely *not* very unusual with respect to soil pH and potassium level (K)? (Circle all that apply.)

(a) Observation 66

(b) Observation 65 

(c) Observation 9

(d) Observation 53




## Problem 4 

Which of the following data points are likely *not* very unusual with respect to their observed biomass? (Circle all that apply.)

(a) Observation 66

(b) Observation 65 

(c) Observation 9

(d) Observation 53




# Short answer questions 

## Problem 5 (6 points)


The R-output below contains the results from a regression model fit to a data set concerning life expectancy in years, alcohol consumption in drinks per day, and smoking status (smoker - Yes vs. non-smoker - No). Answer the following questions pertaining to the R output below. 


```{r echo=TRUE, eval=FALSE}
## Call:
## lm(formula = Lifespan ~ Alcohol + Smoker)
 
## Residuals:
## Min 1Q Median 3Q Max
## -30.796 -7.139 0.125 6.949 19.578
 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)
## (Intercept) 93.6818  2.1024     44.56   <2e-16 ***
## Alcohol     -3.2656  0.3147    -10.38   <2e-16 ***
## SmokerYes  -23.4392  1.9922    -11.77   <2e-16 ***
## ---
## Signif. codes: 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
## Residual standard error: 9.959 on 97 degrees of freedom
## Multiple R-squared: 0.7129, Adjusted R-squared: 0.7069
## F-statistic: 120.4 on 2 and 97 DF, p-value: < 2.2e-16
``` 
 

a) How does smoking affect average life expectancy? (Explain in a full sentence.) (2 points)
\vspace{2cm}

b) Suppose someone consumes about 1 alcoholic drink per day and smokes regularly. What is the average life expectancy for this individual? (1 point)
\vspace{2cm}

c) What is the average difference in lifespan between smokers and non-smokers? (1 point)
\vspace{2cm}

d) Suppose we consider only individuals who smoke; is there a statistically significant relationship between life expectancy and alcohol consumption? Justify your answer. (2 points)
\vspace{2cm}

\pagebreak 

***

For Problem 6-8 we are going to consider three different MLR models for vehicle fuel consumption (in miles per gallon) as predicted by the vehicles weight (in lbs) and possibly also by the transmission type where $transmission\_typeM = \begin{cases}1, \text{ if manual vehicle}  \\ 0, \text{ otherwise} \end{cases}$. 

You can assume the vehicles were selected as a simple random sample.  


**Model 1:** $mpg = \beta_0 + \beta_1 weight + \epsilon$ 


**Model 2:** $mpg = \beta_0 + \beta_1 weight + \beta_2 transmission\_typeM + \epsilon$


**Model 3:** 

$mpg = \beta_0 + \beta_1 weight + \beta_2 transmission\_typeM + \beta_3 weight \cdot transmission\_typeM + \epsilon$


The summary for each model and the corresponding residual plots and Normal quantile plots are shown on last three pages after the statement of each problem.  

*** 

## Problem 6 (5 points)

a) Which of the three models would you choose to predict vehicle mileage? Justify your answer. (2 points)
\vspace{5cm}

b) State the null and alternative hypotheses for a test of a linear association among the predictors and response based on your answer to part (a). For an $\alpha = 0.05$ significance level, report the p-value and interpret the conclusion of this test in the context of the problem. (3 points)
 
\vspace{5cm}

## Problem 7 (5 points)

a) State the null and alternative hypotheses for a test of the significance of the categorical predictor variable when using Model 3 as the full model. (2 points)
 
\vspace{5cm}


b) Which of the tests in Problem 6.b or Problem 7.a is most reliable? Briefly explain. (3 points)
\vspace{5cm}

##  Problem 8 (6 points)

Suppose someone suggests that we should add another predictor variable displacement, which measures the displacement of the vehicle's engine (in inches). Describe what steps you could take to statistically support (or not) this decision without conducting any tests or calculating any confidence intervals. (More points will be awarded for more valid methods with accurate justifications.)






\pagebreak 

### Model 1:
$mpg = \beta_0 + \beta_1 weight + \epsilon$ 

```{r echo=FALSE}
mileage_dat <- read_csv("mileage_ST_edit.csv")
#car_dat <- read_csv("auto-mpg.csv")
car_dat <- mileage_dat %>% mutate(log_mpg = log(mpg))
#car_dat %>% head
mpg_mod1 <- lm(mpg ~ weight, data=car_dat)
mpg_mod1 %>% summary
mpg_mod2 <- lm(mpg ~ weight + transmission_type, data=car_dat)
mpg_mod3 <- lm(mpg ~  weight + transmission_type + weight:transmission_type , data=car_dat)
mpg_mod4 <- lm(log_mpg ~ weight, data=car_dat)

car_dat_full <- car_dat %>% 
                  mutate(resids1 = rstudent(mpg_mod1),
                         fits1 = mpg_mod1$fitted.values,
                         resids2 = rstudent(mpg_mod2), 
                         fits2 = mpg_mod2$fitted.values,
                         resids3 = rstudent(mpg_mod3),
                         fits3 = mpg_mod3$fitted.values,
                         resids4 = rstudent(mpg_mod4), 
                         fits4 = mpg_mod4$fitted.values)
```

```{r}
p1 <- ggplot(car_dat_full, aes(x=fits1, y=resids1)) + 
  geom_point() + ylim(-3,3) + # geom_text(label=rownames(car_dat_full), nudge_y = -.2) +
  labs(main = "Model 1", x= "Fitted Values", y="Studentized Residuals")
p2 <- ggplot(car_dat_full, aes(sample=resids1)) + 
  stat_qq() + 
  stat_qq_line() +
  labs(main = "Normal quantile plot", x="Theoretical quantiles", y="Observed residual quantiles")
grid.arrange(p1, p2, ncol=2)
```
\pagebreak 
\vspace{5cm}
.

\pagebreak 

### Model 2:
$mpg = \beta_0 + \beta_1 weight + \beta_2 transmission\_typeM + \epsilon$


```{r echo=FALSE}
mpg_mod2 %>% summary
```


```{r}
p3 <- ggplot(car_dat_full, aes(x=fits2, y=resids2)) + 
  geom_point() +ylim(-3,3) +  # geom_text(label=rownames(car_dat_full), nudge_y = -.2) +
  labs(main = "Model 2", x= "Fitted Values", y="Studentized Residuals")
p4 <- ggplot(car_dat_full, aes(sample=resids2)) + 
  stat_qq() + 
  stat_qq_line() +
  labs(main = "Normal quantile plot", x="Theoretical quantiles", y="Observed residual quantiles")
grid.arrange(p3, p4, ncol=2)
```

\pagebreak
\vspace{5cm}
.

\pagebreak 

### Model 3: 
$mpg = \beta_0 + \beta_1 weight + \beta_2 transmission\_typeM + \beta_3 weight \cdot transmission\_typeM + \epsilon$

```{r echo=FALSE}
mpg_mod3 %>% summary
#mpg_mod4 %>% summary
```

### Model 3: 

```{r}
p5 <- ggplot(car_dat_full, aes(x=fits3, y=resids3)) + 
  geom_point() +ylim(-3,3) +   # geom_text(label=rownames(car_dat_full), nudge_y = -.2) +
  labs(main = "Model 3", x= "Fitted Values", y="Studentized Residuals")
p6 <- ggplot(car_dat_full, aes(sample=resids3)) + 
  stat_qq() + 
  stat_qq_line() +
  labs(main = "Normal quantile plot", x="Theoretical quantiles", y="Observed residual quantiles")
grid.arrange(p5, p6, ncol=2)
```

```{r eval=FALSE}
p7 <- ggplot(car_dat_full, aes(x=fits4, y=resids4)) + 
  geom_point() +
  labs(main = "Model 4", x= "Fitted Values", y="Studentized Residuals")
p8 <- ggplot(car_dat_full, aes(sample=resids4)) + 
  stat_qq() + 
  stat_qq_line() +
  labs(main = "Normal quantile plot", x="Theoretical quantiles", y="Observed residual quantiles")
grid.arrange(p7, p8, ncol=2)
```







