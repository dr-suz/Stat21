---
title: "Class 10"
subtitle: "Statistical Methods II (Stat 021)"
author: "Suzanne Thornton"
institute: "Swarthmore College"
date: "For class on Tuesday, March 16, 2021 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
 #   css: ["default", "assets/sydney-fonts.css", "assets/sydney.css"]
    self_contained: false # if true, fonts will be stored locally
#    includes:
 #     in_header: "assets/mathjax-equation-numbers.html"
    nature:
#      beforeInit: ["assets/remark-zoom.js", "https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9' # alternatives '16:9' or '4:3' or others e.g. 13:9
      navigation:
        scroll: false # disable slide transitions by scrolling
includes:
  in_header: mystyles.sty
---

```{r setup_pres, include=FALSE, echo=FALSE}
#devtools::install_github("ropenscilabs/icon")
#devtools::session_info('rmarkdown')

rm(list=ls())
library('tidyverse')
library('gridExtra')
library('broom')
library('cowplot')
library("RefManageR")
library("DT")

#setwd("~/Google Drive Swat/Swat docs/Stat 21/Class13_files")
#setwd("~/Drive/Swat docs/Stat 21/Class9_files")
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.path='Figs/',echo=TRUE, warning=FALSE, message=FALSE)
```

```{css, echo=FALSE}
pre {
  background: #FFBB33;
  max-width: 100%;
  overflow-x: scroll;
}

.scroll-output {
  height: 60%;
  overflow-y: scroll;
}

.scroll-small {
  height: 30%;
  overflow-y: scroll;
}
   
.red{color: #ce151e;}
.green{color: #26b421;}
.blue{color: #426EF0;}
```


# Agenda

Here's the agenda for today's class: 

- Group check-ins (5 mins)

- ANOVA Assumptions

- ANOVA Setting 

- Housekeeping items and announcements (5 mins)

---
# Tuesday check-in 

- Send me a screenshot of your check-in markers on Slack

- [Fill out the group roles for today's class](https://docs.google.com/spreadsheets/d/1d34JxqXQON6MyIEjN5ugkByCeTuGTTb_ovvPfSAca_g/edit?usp=sharing) 

```{r, echo=FALSE, fig.align='center', out.height=500}
knitr::include_graphics("Figs/feelings_wheel.jpg")
```

---
## Types of data and methods of analysis

We use different methods to investigate different types of variables. 
  - For a single **quantitative** variable
    - Histogram
    - Mean, median, variance
  - For a single **categorical** variable 
    - Bar chart
    - Contingency table
    - Proportions, probabilities/distributions (of success or a particular category)
  - For two variables 
    - **One quantitative, one categorical** 
      * Box plots
      * ANOVA 
    - **Both categorical** 
      * Two-way contingency table
      * Test for independence
    - **Both quantitative** 
      * Scatter plot
      * Correlation 
      * Linear regression


---
## ANOVA Setting

Variables types and rolls

  - Predictor; categorical; $x$; observed without any measurement error
  
  - Response; numeric; $Y$; observed with some well-behaved random measurement error

We only care about the average value of the numeric response across the different levels of the predictor.

$$Y_{i,j}  = \mu_{j} + \epsilon_{i,j}$$ 

Here $j = 1,\dots, k$ and $i = 1, \dots, n_{i}$ and $\mu_{j}=\bar{x}_{j}$. The total sample size is $n = n_{1} + n_{2} + \dots + n_{k}$. 

---
## Example 
## Penguin data group work

.scroll-output[
```{r echo=TRUE, results='hide'}
#install.packages("remotes")
#remotes::install_github("allisonhorst/palmerpenguins") 
library("palmerpenguins")
library("tidyverse")
penguins2 <- penguins %>% 
             na.omit() %>% ## this is a very useful function that will omit an entire row if any of the column values are missing (NA)
             mutate(bill_length_standard =  (bill_length_mm-mean(bill_length_mm))/sd(bill_length_mm))  ## or bill_length_standard = scale(bill_length_mm)
head(penguins2)
```


**Instructions:** Work with your group to answer the questions in Part 1 of the Class 10 [worksheet](https://docs.google.com/document/d/1UuY5--VHe2J_-21CtNKTgJ_IfHBw7BXiDT3MycEcF1g/edit?usp=sharing). You will want to copy and paste the code into an R script file (ending in .R). 



**Group roles:**

- Recorder - Create a copy of the worksheet and share your screen with your group mates as you fill in the answers together. When there is 1 min remaining, share your answers with me via a DM on Slack. 

- Reporter - Keep track of your group's progress on the Google spreadsheet and be prepared to discuss your group's answers (or any additional questions) with the class.  

- Questioner - Do your thing and ask questions! ]
 

---
## ANOVA Setting
### Assumptions

1. Independence 
    - The $k$ levels are independent. 
    - The data is independent. I.e. Each $\epsilon_{i,j}$ is independent of any other random measurement error. 
1. Equal variance 
    - Homogeneity of variance. I.e. Across each of the $j = 1,\dots,k$ levels, $Var(\epsilon_j)=\sigma^2$. 
    - Some other terms for this concept are homoskedasticity/heteroskedasticity 
1. Normal population
    - The random errors, $\epsilon_{i,j}$ are all observations from a Normally distributed population. 
    - **Q:** What is the population here? 


The independence assumption is the most important one! 

--
- Violations of the homogeneity of variance assumption are most problematic if the ANOVA is unbalanced (i.e. if the category sample sizes $n_1, \dots, n_k$ differ) or if there are systematic patterns to the changes in spread. 

- A helpful rule of thumb is to aim to have at least a dozen or so observations within each category (otherwise the homogeneity of variance is a difficult assumption to verify). 

---
## ANOVA 
### Setting and assumptions

| Categorical varb | $n$ | Sample mean | Population mean | Sample variance | Population variance | 
|-----------------|-----|------|-------|----|---|----|
| Level 1 | $n_1$ | $\bar{y}_{1}$ | $\mu_{1}$ | $s_{1}^{2}$ | $\sigma_{1}^{2}$ |
| Level 2 | $n_2$ | $\bar{y}_{2}$ | $\mu_{2}$ | $s_{2}^{2}$ | $\sigma_{2}^{2}$ |
| $\vdots$ |  |   |   |    |   |   |
| Level K | $n_K$ | $\bar{y}_{K}$ | $\mu_{K}$ | $s_{K}^{2}$ | $\sigma_{K}^{2}$ |

Note that we assume $\sigma_{1}^{2} = \sigma_{2}^{2} = \cdots = \sigma_{K}^2 = \sigma^2$! 


--
Random fluctuation in the sample variances over each level is going to occur. This is not a huge concern *unless* there appears to be a systematic variation in sample variances across each level. 
Something done systematically is typically done explicitly and intentionally, not just a one-off occurrence. 

The key is that we are looking for patterns! For example, do groups with larger means tend to also have larger variances? Or maybe groups with larger means tend to have smaller variances and groups with smaller means have larger variances. Either of these situations is indicative of systematic sages in the variability of the data.



---
## ANOVA hypothesis
### F-test for overall difference in means

The hypothesis for an ANOVA test is

$$H_0: \mu_1 = \mu_2 = \dots = \mu_k \\ H_A: \text{ Not all }\mu_i \text{ are equal, for }i=1,\dots,k$$


You can think of an ANOVA model as a generalization of the t-test for the difference in means. With ANOVA, we can test if **more than two** group means are the same. 


--
**Q:** Why not do a bunch of t-tests instead of one ANOVA test? 


---
## Answer to question


If all our tests were independent, (this is not likely to be the case but it's the "best" of the worst case scenarios) then as the number of tests increases, so does our chance of randomly incorrectly rejecting the null hypothesis. 


$$Pr( \text{making a type I error}) = \alpha \\
Pr(\text{not making a type I error}) = 1- \alpha$$

$$Pr(\text{not making a type I error in m independent hypothesis tests}) \\
= (1-\alpha)^m\\
Pr(\text{making at least one type I error our of m tests}) \\ = 1 - (1-\alpha)^m$$

---
## Answer to question


```{r sigLevelClass16}
1 - (1 - 0.05)      ## a single test
1 - (1 - 0.05)^3    ## three tests
1 - (1 - 0.05)^10   ## 10 tests
```

.footnote[For more on the problem of multiple testing go <a href="https://www.stat.berkeley.edu/~mgoldman/Section0402.pdf">here</a>.

For an alternative (Bayesian) approach to avoid dealing with multiple testing problem see <a href="http://www.stat.columbia.edu/~gelman/research/published/multiple2f.pdf">this</a> paper. NOT on future test, just FYI]


---
## ANOVA Assumptions
### Penguin data

Using the outlines of code below, create a histogram and Normal probability plot for the standardized bill length. Then create a box plot of the quantitivative variable standardized bill length of the penguins across each of the different islands, the categorical predictor variable. (Hint: make sure the categorical variable is factored!)  

Open the Google doc [worksheet](https://docs.google.com/document/d/1UuY5--VHe2J_-21CtNKTgJ_IfHBw7BXiDT3MycEcF1g/edit?usp=sharing) and work with your group on Part 2. 


```{r echo=TRUE}
#ggplot(?, aes(sample = ?)) + 
#  stat_qq() + 
#  stat_qq_line() + 
#  labs(title = "?")

#ggplot(?, aes(x = ?)) + 
#  geom_histogram(bins=?) + 
#  labs(title = "?")

#ggplot(?, aes(x = ?, y = ?)) + 
#  geom_boxplot() + 
#  labs(title = "?") +
#  xlab("?") + ylab("?")
```

```{r class10.1, echo=FALSE, eval=FALSE, warning=FALSE, fig.height = 4, fig.width = 10, fig.align = 'center'}
ggplot(penguins2, aes(sample = bill_length_standard)) + 
  stat_qq() + 
  stat_qq_line() + 
  labs(title = "Normal probability plot", subtitle = "Penguin bill length (standardized)")
```

```{r class10.2, echo=FALSE, eval=FALSE, warning=FALSE, fig.height = 4, fig.width = 10, fig.align = 'center'}
ggplot(penguins2, aes(x = bill_length_standard)) + 
  geom_histogram(bins=30) + 
  labs(title = "Histogram for penguin bill length (standardized)")
```

```{r class10.3, echo=FALSE, eval=FALSE}
ggplot(penguins2, aes(x = island, y = bill_length_mm)) + 
  geom_boxplot() + 
  labs(title = "Box plots for penguin bill length according to island") +
  xlab("Island") + ylab("Bill length (in mm)")
```



---
## ANOVA F-test
### Calculations by hand

R will automatically create the following ANOVA table for you. 

| Source | Sums of Squares | DF | Mean Square | F-ratio | P-value | 
|--------|------------------|---|-------------|---------|---------|
| Treatment | $SS_{trt}= \sum \sum(\bar{y}_{j}-\bar{\bar{y}})^2$ | $K-1$ | $MS_{trt} = \frac{SS_{trt}}{K-1}$ | $\frac{MS_{trt}}{MSE}$ | $Pr(F \geq \frac{MS_{trt}}{MSE})$ | 
| Error | $SSE=\sum\sum(y_{ij}-\bar{y}_{j})^2$ | $n-K$ | $MSE = \frac{SSE}{n-K}$ |   |  | 
| Total | $SS_{tot}=SS_{trt}+SSE$  | $n-1$ |   |   |   |


Behind the scenes, R calculates...

$$\text{Test Statistic} = F-statistic = \frac{MS_{trt}}{MSE},$$
and then computes the p-value. 

The **p-value** is the probability that a **F-distributed RV** with numerator degrees of freedom $K-1$ and denominator degrees of freedom $n-K$ takes on the observed F-ratio or a larger number. 




---
## ANOVA F-test
### Table calculations by hand for penguin data

With your group, use R to help you fill in the elements of this [ANOVA table](https://docs.google.com/spreadsheets/d/1VjWLaPq_JW8OucQDhkijlajDn8T8zUTTc6yWlcV14-I/edit?usp=sharing) for the `penguins2` data set below.

.scroll-output[
```{r echo=TRUE, eval=FALSE}
anova_model <- lm(bill_length_mm ~ factor(island), penguins2)
summary(anova_model)

penguins2 %>% group_by(factor(island)) %>% 
              summarize(mean_bill = mean(bill_length_mm),
              var_bill = var(bill_length_mm),
              samp_size = length(bill_length_mm))
```
]

---
## More examples of ANOVA
### Group work 

With your group, find a published academic paper in a field besides statistics that used a one-way ANOVA model. 

1. Identify the response and predictor variables. 

1. What are likely some causes of measurement error in the response variable? 

1. Do the assumptions of independence seem likely to be met? 


---
### Planning ahead for next class  

- Complete the comprehension quiz for week 6 by Thursday morning. (This will be available by tonight.)

- Read over HW 4 (This will be available by tonight as well.) 

- Next class, we'll be discussing
  
  * Simpson's paradox
  
  * Experimental design 
  
  * HW 4 problems 

- Test 1 will be graded by next Tuesday.   


